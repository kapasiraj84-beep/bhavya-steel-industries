<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Bhavya Steel Industries</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        .header { background: linear-gradient(135deg, #0a1628 0%, #2563eb 100%); color: white; padding: 1.5rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #2563eb; }
        .stat-card.pending { border-left-color: #f59e0b; }
        .stat-card.converted { border-left-color: #10b981; }
        .stat-card.total { border-left-color: #6366f1; }
        .stat-card h3 { color: #64748b; font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; text-transform: uppercase; }
        .stat-card .value { font-size: 2.5rem; font-weight: 800; color: #0f172a; }
        .stat-card .change { font-size: 0.85rem; color: #10b981; margin-top: 0.5rem; }
        
        .filters { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 2rem; }
        .filters h3 { margin-bottom: 1rem; color: #0f172a; }
        .filter-group { display: flex; gap: 1rem; flex-wrap: wrap; }
        .filter-group select, .filter-group input { padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; }
        .filter-group button { padding: 0.75rem 1.5rem; background: #2563eb; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .filter-group button:hover { background: #1e40af; }
        
        .quotes-table { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
        .quotes-table h3 { padding: 1.5rem; background: #f8fafc; border-bottom: 2px solid #e2e8f0; color: #0f172a; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f8fafc; }
        th { padding: 1rem; text-align: left; font-weight: 700; color: #475569; font-size: 0.85rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #334155; }
        tr:hover { background: #f8fafc; }
        
        .status-badge { padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-contacted { background: #dbeafe; color: #1e40af; }
        .status-quoted { background: #e0e7ff; color: #4338ca; }
        .status-converted { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }
        
        .action-btn { padding: 0.5rem 1rem; margin: 0 0.25rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
        .btn-view { background: #3b82f6; color: white; }
        .btn-edit { background: #10b981; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .action-btn:hover { opacity: 0.9; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; max-width: 800px; margin: 2rem auto; border-radius: 12px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; background: linear-gradient(135deg, #0a1628 0%, #2563eb 100%); color: white; border-radius: 12px 12px 0 0; }
        .modal-body { padding: 2rem; }
        .modal-close { float: right; font-size: 1.5rem; cursor: pointer; }
        
        .detail-row { display: grid; grid-template-columns: 200px 1fr; gap: 1rem; padding: 1rem 0; border-bottom: 1px solid #e2e8f0; }
        .detail-label { font-weight: 700; color: #64748b; }
        .detail-value { color: #0f172a; }
        
        .loading { text-align: center; padding: 3rem; color: #64748b; }
        .error { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-chart-line"></i> Admin Dashboard</h1>
        <p>Bhavya Steel Industries - Quote Management System</p>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card total">
                <h3>Total Quotes</h3>
                <div class="value" id="totalQuotes">0</div>
                <div class="change">All time</div>
            </div>
            <div class="stat-card pending">
                <h3>Pending</h3>
                <div class="value" id="pendingQuotes">0</div>
                <div class="change">Awaiting response</div>
            </div>
            <div class="stat-card converted">
                <h3>Converted</h3>
                <div class="value" id="convertedQuotes">0</div>
                <div class="change" id="conversionRate">0% conversion</div>
            </div>
            <div class="stat-card">
                <h3>This Month</h3>
                <div class="value" id="monthlyQuotes">0</div>
                <div class="change">Last 30 days</div>
            </div>
        </div>

        <div class="filters">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <div class="filter-group">
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="contacted">Contacted</option>
                    <option value="quoted">Quoted</option>
                    <option value="converted">Converted</option>
                    <option value="rejected">Rejected</option>
                </select>
                <input type="date" id="dateFrom" placeholder="From Date">
                <input type="date" id="dateTo" placeholder="To Date">
                <input type="text" id="searchQuery" placeholder="Search by name, email, phone...">
                <button onclick="applyFilters()"><i class="fas fa-search"></i> Apply Filters</button>
                <button onclick="exportData()" style="background: #10b981;"><i class="fas fa-download"></i> Export CSV</button>
            </div>
        </div>

        <div class="quotes-table">
            <h3><i class="fas fa-list"></i> Recent Quote Requests</h3>
            <div id="tableContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p>Loading quotes...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="quoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <h2><i class="fas fa-file-invoice"></i> Quote Details</h2>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Quote details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let allQuotes = [];

        async function loadDashboard() {
            try {
                // Load analytics
                const analyticsRes = await fetch(`${API_URL}/analytics`);
                const analytics = await analyticsRes.json();
                
                if (analytics.success) {
                    document.getElementById('totalQuotes').textContent = analytics.data.summary.total;
                    document.getElementById('pendingQuotes').textContent = analytics.data.summary.pending;
                    document.getElementById('convertedQuotes').textContent = analytics.data.summary.converted;
                    document.getElementById('conversionRate').textContent = `${analytics.data.summary.conversionRate}% conversion`;
                }

                // Load quotes
                const quotesRes = await fetch(`${API_URL}/quotes?limit=100`);
                const quotesData = await quotesRes.json();
                
                if (quotesData.success) {
                    allQuotes = quotesData.data;
                    renderQuotesTable(allQuotes);
                }
            } catch (error) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-triangle"></i> Error loading data: ${error.message}
                    </div>
                `;
            }
        }

        function renderQuotesTable(quotes) {
            if (quotes.length === 0) {
                document.getElementById('tableContainer').innerHTML = '<div class="loading">No quotes found</div>';
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quotes.map(quote => `
                            <tr>
                                <td>${new Date(quote.createdAt).toLocaleDateString()}</td>
                                <td><strong>${quote.name}</strong></td>
                                <td>${quote.company || 'N/A'}</td>
                                <td>${quote.email}</td>
                                <td>${quote.phone}</td>
                                <td>${quote.category}</td>
                                <td>${quote.location}</td>
                                <td><span class="status-badge status-${quote.status}">${quote.status}</span></td>
                                <td>
                                    <button class="action-btn btn-view" onclick="viewQuote('${quote._id}')">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn btn-edit" onclick="updateStatus('${quote._id}')">
                                        <i class="fas fa-edit"></i> Update
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tableContainer').innerHTML = html;
        }

        async function viewQuote(id) {
            try {
                const res = await fetch(`${API_URL}/quotes/${id}`);
                const data = await res.json();
                
                if (data.success) {
                    const quote = data.data;
                    document.getElementById('modalBody').innerHTML = `
                        <div class="detail-row">
                            <div class="detail-label">Quote ID:</div>
                            <div class="detail-value">${quote._id}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Date Submitted:</div>
                            <div class="detail-value">${new Date(quote.createdAt).toLocaleString()}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Name:</div>
                            <div class="detail-value"><strong>${quote.name}</strong></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Company:</div>
                            <div class="detail-value">${quote.company || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Email:</div>
                            <div class="detail-value"><a href="mailto:${quote.email}">${quote.email}</a></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Phone:</div>
                            <div class="detail-value"><a href="tel:${quote.phone}">${quote.phone}</a></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Category:</div>
                            <div class="detail-value">${quote.category}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Quantity:</div>
                            <div class="detail-value">${quote.quantity || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Products:</div>
                            <div class="detail-value">${quote.products?.join(', ') || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Specifications:</div>
                            <div class="detail-value">${quote.specifications}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Delivery Location:</div>
                            <div class="detail-value">${quote.location}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Required By:</div>
                            <div class="detail-value">${quote.requiredDate ? new Date(quote.requiredDate).toLocaleDateString() : 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Additional Notes:</div>
                            <div class="detail-value">${quote.notes || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Status:</div>
                            <div class="detail-value"><span class="status-badge status-${quote.status}">${quote.status}</span></div>
                        </div>
                    `;
                    document.getElementById('quoteModal').style.display = 'block';
                }
            } catch (error) {
                alert('Error loading quote details: ' + error.message);
            }
        }

        async function updateStatus(id) {
            const newStatus = prompt('Enter new status (pending/contacted/quoted/converted/rejected):');
            if (!newStatus) return;

            try {
                const res = await fetch(`${API_URL}/quotes/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('Status updated successfully!');
                    loadDashboard();
                }
            } catch (error) {
                alert('Error updating status: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('quoteModal').style.display = 'none';
        }

        function applyFilters() {
            let filtered = [...allQuotes];
            
            const status = document.getElementById('statusFilter').value;
            if (status) {
                filtered = filtered.filter(q => q.status === status);
            }
            
            const search = document.getElementById('searchQuery').value.toLowerCase();
            if (search) {
                filtered = filtered.filter(q => 
                    q.name.toLowerCase().includes(search) ||
                    q.email.toLowerCase().includes(search) ||
                    q.phone.includes(search) ||
                    (q.company && q.company.toLowerCase().includes(search))
                );
            }
            
            renderQuotesTable(filtered);
        }

        async function exportData() {
            window.location.href = `${API_URL}/export`;
        }

        // Load dashboard on page load
        loadDashboard();

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('quoteModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>